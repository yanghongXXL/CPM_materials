<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 3 部分 R 实操 | 临床预测模型</title>
<meta name="author" content="杨 弘">
<meta name="description" content="3.1 机器学习模型构建  3.1.1 加载需要的r包 rm(list = ls()) library(tidyverse) # 数据整理 library(dlookr) # 自动化EDA library(plotROC) # 绘制ROC library(pROC) # 计算AUC library(e1071) # 支持向量机 library(caret) # 机器学习包...">
<meta name="generator" content="bookdown 0.32 with bs4_book()">
<meta property="og:title" content="第 3 部分 R 实操 | 临床预测模型">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/封面.png">
<meta property="og:description" content="3.1 机器学习模型构建  3.1.1 加载需要的r包 rm(list = ls()) library(tidyverse) # 数据整理 library(dlookr) # 自动化EDA library(plotROC) # 绘制ROC library(pROC) # 计算AUC library(e1071) # 支持向量机 library(caret) # 机器学习包...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第 3 部分 R 实操 | 临床预测模型">
<meta name="twitter:description" content="3.1 机器学习模型构建  3.1.1 加载需要的r包 rm(list = ls()) library(tidyverse) # 数据整理 library(dlookr) # 自动化EDA library(plotROC) # 绘制ROC library(pROC) # 计算AUC library(e1071) # 支持向量机 library(caret) # 机器学习包...">
<meta name="twitter:image" content="/images/封面.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">临床预测模型</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">关于课程</a></li>
<li><a class="" href="%E6%A1%88%E4%BE%8B%E6%95%99%E5%AD%A6-1.html">案例教学</a></li>
<li><a class="" href="%E5%81%A5%E5%BA%B7%E5%8C%BB%E7%96%97%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E4%B8%8B%E7%9A%84%E4%B8%B4%E5%BA%8A%E7%A7%91%E7%A0%94.html"><span class="header-section-number">1</span> 健康医疗大数据驱动下的临床科研</a></li>
<li><a class="" href="%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D.html"><span class="header-section-number">2</span> 案例介绍</a></li>
<li><a class="" href="%E5%AE%9E%E6%93%8D%E6%95%99%E5%AD%A6-1.html">实操教学</a></li>
<li><a class="active" href="r-%E5%AE%9E%E6%93%8D.html"><span class="header-section-number">3</span> R 实操</a></li>
<li><a class="" href="python-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%85%A5%E9%97%A8.html"><span class="header-section-number">4</span> Python 安装与入门</a></li>
<li><a class="" href="r%E5%AE%89%E8%A3%85%E4%B8%8E%E5%85%A5%E9%97%A8.html"><span class="header-section-number">5</span> R安装与入门</a></li>
<li><a class="" href="r%E5%85%A5%E9%97%A8-1.html"><span class="header-section-number">6</span> R入门</a></li>
<li><a class="" href="nhanes%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%8B%E7%BB%8D.html"><span class="header-section-number">7</span> NHANES数据库介绍</a></li>
<li><a class="" href="mimic%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%8B%E7%BB%8D.html"><span class="header-section-number">8</span> MIMIC数据库介绍</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="r-实操" class="section level1" number="3">
<h1>
<span class="header-section-number">第 3 部分</span> R 实操<a class="anchor" aria-label="anchor" href="#r-%E5%AE%9E%E6%93%8D"><i class="fas fa-link"></i></a>
</h1>
<div id="机器学习模型构建" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> <strong>机器学习模型构建</strong><a class="anchor" aria-label="anchor" href="#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA"><i class="fas fa-link"></i></a>
</h2>
<div id="加载需要的r包" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> <strong>加载需要的r包</strong><a class="anchor" aria-label="anchor" href="#%E5%8A%A0%E8%BD%BD%E9%9C%80%E8%A6%81%E7%9A%84r%E5%8C%85"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># 数据整理</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/choonghyunryu/dlookr/">dlookr</a></span><span class="op">)</span> <span class="co"># 自动化EDA</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sachsmc.github.io/plotROC/">plotROC</a></span><span class="op">)</span> <span class="co"># 绘制ROC</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://expasy.org/tools/pROC/">pROC</a></span><span class="op">)</span> <span class="co"># 计算AUC</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span> <span class="co"># 支持向量机</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span> <span class="co"># 机器学习包</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/rms/">rms</a></span><span class="op">)</span> <span class="co"># 计算校准曲线\绘制nomo</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu">glmnet</a></span><span class="op">)</span> <span class="co"># lasso</span></span></code></pre></div>
</div>
<div id="加载数据" class="section level3" number="3.1.2">
<h3>
<span class="header-section-number">3.1.2</span> <strong>加载数据</strong><a class="anchor" aria-label="anchor" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/CardiovascularDataset.csv"</span><span class="op">)</span></span>
<span><span class="co"># dlookr 是一个自动输出一份数据诊断报告包，可以自行探索</span></span>
<span><span class="co"># eda_report(data) # 输出诊断报告</span></span>
<span><span class="co"># eda_report(data, target = 1) # 添加按照target的分组信息</span></span></code></pre></div>
<ul>
<li>查看数据情况</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 查看前10行树</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span>,<span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 10 × 14
##     age   sex    cp trest…¹  chol   fbs restecg thalach
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1    63     1     3     145   233     1       0     150
## 2    53     1     0     140   203     1       0     155
## 3    41     0     1     130   204     0       0     172
## 4    56     1     1     120   236     0       1     178
## 5    60     1     0     130   206     0       0     132
## 6    57     1     0     140   192     0       1     148
## # … with 4 more rows, 6 more variables: exang &lt;dbl&gt;,
## #   oldpeak &lt;dbl&gt;, slope &lt;dbl&gt;, ca &lt;dbl&gt;, thal &lt;dbl&gt;,
## #   target &lt;dbl&gt;, and abbreviated variable name
## #   ¹​trestbps</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 查看数据变量属性</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code>## spc_tbl_ [303 × 14] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
##  $ age     : num [1:303] 63 53 41 56 60 57 56 44 52 57 ...
##  $ sex     : num [1:303] 1 1 0 1 1 1 0 1 1 1 ...
##  $ cp      : num [1:303] 3 0 1 1 0 0 1 1 2 2 ...
##  $ trestbps: num [1:303] 145 140 130 120 130 140 140 120 172 150 ...
##  $ chol    : num [1:303] 233 203 204 236 206 192 294 263 199 168 ...
##  $ fbs     : num [1:303] 1 1 0 0 0 0 0 0 1 0 ...
##  $ restecg : num [1:303] 0 0 0 1 0 1 0 1 1 1 ...
##  $ thalach : num [1:303] 150 155 172 178 132 148 153 173 162 174 ...
##  $ exang   : num [1:303] 0 1 0 0 1 0 0 0 0 0 ...
##  $ oldpeak : num [1:303] 2.3 3.1 1.4 0.8 2.4 0.4 1.3 0 0.5 1.6 ...
##  $ slope   : num [1:303] 0 0 2 2 1 1 1 2 2 2 ...
##  $ ca      : num [1:303] 0 0 0 0 2 0 0 0 0 0 ...
##  $ thal    : num [1:303] 1 3 2 2 3 1 2 3 3 2 ...
##  $ target  : num [1:303] 1 0 1 1 0 1 1 1 1 1 ...
##  - attr(*, "spec")=
##   .. cols(
##   ..   age = col_double(),
##   ..   sex = col_double(),
##   ..   cp = col_double(),
##   ..   trestbps = col_double(),
##   ..   chol = col_double(),
##   ..   fbs = col_double(),
##   ..   restecg = col_double(),
##   ..   thalach = col_double(),
##   ..   exang = col_double(),
##   ..   oldpeak = col_double(),
##   ..   slope = col_double(),
##   ..   ca = col_double(),
##   ..   thal = col_double(),
##   ..   target = col_double()
##   .. )
##  - attr(*, "problems")=&lt;externalptr&gt;</code></pre>
</div>
<div id="划分数据集" class="section level3" number="3.1.3">
<h3>
<span class="header-section-number">3.1.3</span> 划分数据集<a class="anchor" aria-label="anchor" href="#%E5%88%92%E5%88%86%E6%95%B0%E6%8D%AE%E9%9B%86"><i class="fas fa-link"></i></a>
</h3>
<p>使用caret包来生成并比较不同的模型与性能。</p>
<p>使用sample()函数，将数据集按照8:2随机拆分为训练集（264例）和测试集（61例）</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1002</span><span class="op">)</span></span>
<span><span class="va">trainset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">testset</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">trainset</span>,<span class="op">]</span></span>
<span><span class="va">trainset</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">trainset</span>, <span class="op">]</span></span></code></pre></div>
<ul>
<li>为方便后续建模，将target转为factor</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trainset</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">trainset</span><span class="op">$</span><span class="va">target</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span></span>
<span><span class="va">trainset</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">trainset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">trainset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  Factor w/ 2 levels "no","yes": 1 2 1 2 2 1 1 1 1 1 ...</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># str(testset)</span></span></code></pre></div>
</div>
<div id="lasso变量筛选" class="section level3" number="3.1.4">
<h3>
<span class="header-section-number">3.1.4</span> lasso变量筛选<a class="anchor" aria-label="anchor" href="#lasso%E5%8F%98%E9%87%8F%E7%AD%9B%E9%80%89"><i class="fas fa-link"></i></a>
</h3>
<p>在统计学习中存在一个重要理论：<strong>方差权衡</strong>。一般常理认为模型建立得越复杂，分析和预测效果应该越好。而方差权衡恰恰指出了其中的弊端。复杂的模型一般对已知数据（training sample）的拟合（fitting）大过于简单模型，但是<strong>复杂模型很容易对数据出现过度拟合（over-fitting）</strong>。因为所有实际数据都会有各种形式的误差，过度拟合相当于把误差也当做有用的信息进行学习。<strong>所以在未知数据（test sample）上的分析和预测效果会大大下降。</strong></p>
<p>下图说明了方差权衡的结果。模型复杂度在<strong>最低的时候（比如线性回归）预测的偏差比较大，但是方差很小</strong>。随着模型复杂度的增大，对已知数据的预测误差会一直下降（因为拟合度增大），而对未知数据却出现拐点，一旦过于复杂，预测方差会变大，模型变得非常不稳定。</p>
<div class="inline-figure"><img src="images/%E6%96%B9%E5%B7%AE%E6%9D%83%E8%A1%A1-%E8%BF%87%E6%8B%9F%E5%90%88%E4%B8%8E%E6%8B%9F%E5%90%88%E4%B8%8D%E8%B6%B3.jpg" style="width:100.0%"></div>
<p>因此在很多实际生活应用中，线性模型因为其预测方差小，参数估计稳定可靠，仍然起着相当大的作用。正如上面的方差权衡所述，<strong>建立线性模型中一个重要的问题就是变量选择（或者叫模型选择），指的是选择建立线性模型所用到的独立变量的选择。</strong>在实际问题例如疾病风险控制中，独立变量一般会有200 ~ 300个之多。如果使用所有的变量，很可能会出现模型的过度拟合。所以对<strong>变量的选择显得尤为重要</strong>。</p>
<p>传统的变量选择是采用逐步回归法（stepwise selection），其中又分为向前（forward）和向后（backward）的逐步回归。向前逐步是从0个变量开始逐步加入变量，而向后逐步是从所有变量的集合开始逐次去掉变量。加入或去掉变量一般按照标准的统计信息量来决定。<strong>这种传统的变量选择的弊端是模型的方差一般会比较高，而且灵活性较差</strong>。</p>
<p>近年来回归分析中的一个重大突破是引入了正则化回归（regularized regression）的概念, 而最受关注和广泛应用的<strong>正则化回归</strong>是1996年由现任斯坦福教授的Robert Tibshirani提出的<strong>LASSO回归</strong>。<strong>LASSO回归最突出的优势在于通过对所有变量系数进行回归惩罚（penalized regression）, 使得相对不重要的独立变量系数变为0，从而排除在建模之外。</strong></p>
<p>LASSO方法不同于传统的逐步回归的最大之处是<strong>它可以对所有独立变量同时进行处理，而不是逐步处理</strong>。这一改进使得建模的<strong>稳定性大大增加</strong>。除此以外，LASSO还具有<strong>计算速度快</strong>，模型容易解释等很多优点。而模型发明者Tibshirani教授也因此获得当年的有统计学诺贝尔奖之称的考普斯总统奖（COPSS award）。</p>
<div id="训练集中变量筛选" class="section level4" number="3.1.4.1">
<h4>
<span class="header-section-number">3.1.4.1</span> 训练集中变量筛选<a class="anchor" aria-label="anchor" href="#%E8%AE%AD%E7%BB%83%E9%9B%86%E4%B8%AD%E5%8F%98%E9%87%8F%E7%AD%9B%E9%80%89"><i class="fas fa-link"></i></a>
</h4>
<ol style="list-style-type: decimal">
<li>首先告诉软件，哪些是你的分类变量。分类变量转为因子</li>
</ol>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data1</span> <span class="op">&lt;-</span> <span class="va">trainset</span></span>
<span></span>
<span><span class="va">data1</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">9</span>,<span class="fl">11</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">data1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">9</span>,<span class="fl">11</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span>, <span class="va">factor</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## tibble [242 × 14] (S3: tbl_df/tbl/data.frame)
##  $ age     : num [1:242] 57 41 43 37 66 46 60 57 61 44 ...
##  $ sex     : Factor w/ 2 levels "0","1": 2 2 2 2 1 2 2 2 2 2 ...
##  $ cp      : Factor w/ 4 levels "0","1","2","3": 1 3 1 3 3 3 1 1 4 1 ...
##  $ trestbps: num [1:242] 165 130 120 130 146 150 145 110 134 110 ...
##  $ chol    : num [1:242] 289 214 177 250 278 231 282 335 234 197 ...
##  $ fbs     : Factor w/ 2 levels "0","1": 2 1 1 1 1 1 1 1 1 1 ...
##  $ restecg : Factor w/ 3 levels "0","1","2": 1 1 1 2 1 2 1 2 2 1 ...
##  $ thalach : num [1:242] 124 168 120 187 152 147 142 143 145 177 ...
##  $ exang   : Factor w/ 2 levels "0","1": 1 1 2 1 1 1 2 2 1 1 ...
##  $ oldpeak : num [1:242] 1 2 2.5 3.5 0 3.6 2.8 3 2.6 0 ...
##  $ slope   : Factor w/ 3 levels "0","1","2": 2 2 2 1 2 2 2 2 2 3 ...
##  $ ca      : Factor w/ 5 levels "0","1","2","3",..: 4 1 1 1 2 1 3 2 3 2 ...
##  $ thal    : Factor w/ 4 levels "0","1","2","3": 4 3 4 3 3 3 4 4 3 3 ...
##  $ target  : Factor w/ 2 levels "no","yes": 1 2 1 2 2 1 1 1 1 1 ...</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>因子的处理,分类变量处理 onehot encodeing（<strong>自由选择</strong>）</li>
</ol>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 为了做lasso把y定义为numeric</span></span>
<span><span class="va">data1</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">data1</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="co"># 分类变量转为factor</span></span>
<span><span class="va">x.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SparseM/man/SparseM.hb.html">model.matrix</a></span><span class="op">(</span><span class="va">data1</span><span class="op">$</span><span class="va">target</span> <span class="op">~</span> <span class="va">data1</span><span class="op">$</span><span class="va">sex</span> <span class="op">+</span> <span class="va">data1</span><span class="op">$</span><span class="va">cp</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">fbs</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">restecg</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">exang</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">slope</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">ca</span><span class="op">+</span><span class="va">data1</span><span class="op">$</span><span class="va">thal</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#生成自变量和因变量矩阵</span></span>
<span><span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x.factors</span>,<span class="va">data1</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#定义y</span></span>
<span><span class="va">y</span><span class="op">=</span><span class="va">data1</span><span class="op">$</span><span class="va">target</span></span></code></pre></div>
<ul>
<li>进行拟合，默认为L1也就是Lasso</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html">glmnet</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="co">#解释偏差百分比以及相应的λ值</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:  glmnet(x = x, y = y, family = "binomial") 
## 
##    Df %Dev Lambda
## 1   0  0.0 0.2410
## 2   1  2.9 0.2200
## 3   1  5.3 0.2000
## 4   3  8.3 0.1830
## 5   4 11.5 0.1660
## 6   4 14.5 0.1520
## 7   5 17.1 0.1380
## 8   5 19.4 0.1260
## 9   7 21.5 0.1150
## 10  7 23.5 0.1050
## 11  8 25.6 0.0952
## 12 10 28.0 0.0868
## 13 11 30.3 0.0791
## 14 11 32.3 0.0720
## 15 12 34.2 0.0656
## 16 12 36.1 0.0598
## 17 12 37.7 0.0545
## 18 12 39.2 0.0496
## 19 12 40.5 0.0452
## 20 14 41.6 0.0412
## 21 14 42.8 0.0376
## 22 14 43.8 0.0342
## 23 14 44.7 0.0312
## 24 14 45.6 0.0284
## 25 14 46.4 0.0259
## 26 14 47.1 0.0236
## 27 15 47.7 0.0215
## 28 16 48.3 0.0196
## 29 16 48.8 0.0178
## 30 16 49.3 0.0163
## 31 16 49.7 0.0148
## 32 17 50.0 0.0135
## 33 17 50.4 0.0123
## 34 18 50.7 0.0112
## 35 18 51.0 0.0102
## 36 19 51.2 0.0093
## 37 19 51.5 0.0085
## 38 19 51.8 0.0077
## 39 20 52.0 0.0070
## 40 20 52.2 0.0064
## 41 20 52.4 0.0058
## 42 20 52.5 0.0053
## 43 20 52.6 0.0049
## 44 20 52.8 0.0044
## 45 21 52.9 0.0040
## 46 21 52.9 0.0037
## 47 21 53.0 0.0033
## 48 21 53.1 0.0031
## 49 21 53.1 0.0028
## 50 21 53.2 0.0025
## 51 21 53.2 0.0023
## 52 21 53.2 0.0021
## 53 21 53.2 0.0019
## 54 21 53.3 0.0017
## 55 21 53.3 0.0016
## 56 21 53.3 0.0014
## 57 21 53.3 0.0013
## 58 21 53.3 0.0012
## 59 21 53.3 0.0011
## 60 21 53.3 0.0010
## 61 21 53.4 0.0009
## 62 21 53.4 0.0008
## 63 21 53.4 0.0008
## 64 21 53.4 0.0007
## 65 21 53.4 0.0006
## 66 21 53.4 0.0006
## 67 21 53.4 0.0005
## 68 21 53.4 0.0005
## 69 21 53.4 0.0004
## 70 21 53.4 0.0004
## 71 21 53.4 0.0004
## 72 21 53.4 0.0003</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#解释偏差不再随着λ值的增加而减小，因此而停止</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#画出收缩曲线图</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit1</span>,label <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-13-1.png" width="576"></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit1</span>,label <span class="op">=</span> <span class="cn">TRUE</span>,xvar <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span><span class="co">#系数值如何随着λ的变化而变化</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-13-2.png" width="576"></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit1</span>,label <span class="op">=</span> <span class="cn">TRUE</span>,xvar <span class="op">=</span> <span class="st">"dev"</span><span class="op">)</span><span class="co">#偏差与系数之间的关系图</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-13-3.png" width="576"></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#指定lamda给出相应参数</span></span>
<span><span class="va">lasso.coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit1</span>, type <span class="op">=</span> <span class="st">"coefficients"</span>,s <span class="op">=</span> <span class="fl">0.040</span> <span class="op">)</span></span>
<span><span class="va">lasso.coef</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                        s1
## (Intercept)    -0.5051894
## data1.sex1     -0.4472455
## data1.cp1       .        
## data1.cp2       0.6233575
## data1.cp3       .        
## data1.fbs1      .        
## data1.restecg1  0.0148096
## data1.restecg2  .        
## data1.exang1   -0.6849315
## data1.slope1   -0.2724767
## data1.slope2    0.1970313
## data1.ca1      -0.9084992
## data1.ca2      -0.9740841
## data1.ca3      -0.6171345
## data1.ca4       .        
## data1.thal1     .        
## data1.thal2     0.1821188
## data1.thal3    -0.7726354
## age             .        
## trestbps       -0.0004619
## chol            .        
## thalach         0.0129917
## oldpeak        -0.2474481</code></pre>
<p>glmnet包在使用cv.glmnet()估计λ值时，默认使用10折交叉验证。在K折交叉验证中，数据被划分成k个相同的子集（折），#每次使用k-1个子集拟合模型，然后使用剩下的那个子集做测试集，最后将k次拟合的结果综合起来（一般取平均数），确定最后的参数。</p>
<p>在这个方法中，每个子集只有一次用作测试集。在glmnet包中使用K折交叉验证非常容易，结果包括每次拟合的λ值和响应的MSE。默认设置为α=1。</p>
<ul>
<li>进行交叉验证，选择最优的惩罚系数lambada</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">317</span><span class="op">)</span></span>
<span><span class="va">cv.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">cv.glmnet</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="co">#cv.fit &lt;- cv.glmnet(x,y,family="binomial",type.measure = "auc")#AUC和λ的关系</span></span>
<span><span class="co">#cv.fit &lt;- cv.glmnet(x,y,family="binomial")#不要反复运行</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cv.fit</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-15-1.png" width="576"></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#显示一个标准误的系数</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">cv.fit</span>, s <span class="op">=</span> <span class="st">"lambda.1se"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                       s1
## (Intercept)    -0.570950
## data1.sex1     -0.429630
## data1.cp1       .       
## data1.cp2       0.610299
## data1.cp3       .       
## data1.fbs1      .       
## data1.restecg1  0.007149
## data1.restecg2  .       
## data1.exang1   -0.678984
## data1.slope1   -0.261868
## data1.slope2    0.194103
## data1.ca1      -0.883563
## data1.ca2      -0.944469
## data1.ca3      -0.586744
## data1.ca4       .       
## data1.thal1     .       
## data1.thal2     0.200315
## data1.thal3    -0.752414
## age             .       
## trestbps       -0.000139
## chol            .       
## thalach         0.012869
## oldpeak        -0.245773</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#选择交叉验证误差最小的lambda</span></span>
<span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.min</span></span></code></pre></div>
<pre><code>## [1] 0.0123</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.1se</span></span></code></pre></div>
<pre><code>## [1] 0.04122</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">cv.fit</span>, s <span class="op">=</span> <span class="st">"lambda.min"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                       s1
## (Intercept)     1.718543
## data1.sex1     -1.058682
## data1.cp1       0.171712
## data1.cp2       1.200687
## data1.cp3       0.727069
## data1.fbs1      .       
## data1.restecg1  0.204794
## data1.restecg2  .       
## data1.exang1   -0.776428
## data1.slope1   -0.609627
## data1.slope2    0.276892
## data1.ca1      -1.635310
## data1.ca2      -1.885126
## data1.ca3      -1.390527
## data1.ca4       0.131830
## data1.thal1     .       
## data1.thal2     .       
## data1.thal3    -1.084248
## age             .       
## trestbps       -0.011442
## chol           -0.001332
## thalach         0.015735
## oldpeak        -0.324021</code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#画出收缩系数图，及最小的lambda曲线</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cv.fit</span><span class="op">$</span><span class="va">glmnet.fit</span>,xvar<span class="op">=</span><span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.min</span>,<span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.1se</span><span class="op">)</span><span class="op">)</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-18-1.png" width="576"></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#系数不为0的结果为Lasso筛选后的值</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cv.fit</span>,type<span class="op">=</span><span class="st">'coefficient'</span>,s<span class="op">=</span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.min</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                       s1
## (Intercept)     1.718543
## data1.sex1     -1.058682
## data1.cp1       0.171712
## data1.cp2       1.200687
## data1.cp3       0.727069
## data1.fbs1      .       
## data1.restecg1  0.204794
## data1.restecg2  .       
## data1.exang1   -0.776428
## data1.slope1   -0.609627
## data1.slope2    0.276892
## data1.ca1      -1.635310
## data1.ca2      -1.885126
## data1.ca3      -1.390527
## data1.ca4       0.131830
## data1.thal1     .       
## data1.thal2     .       
## data1.thal3    -1.084248
## age             .       
## trestbps       -0.011442
## chol           -0.001332
## thalach         0.015735
## oldpeak        -0.324021</code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cv.fit</span>,type<span class="op">=</span><span class="st">'coefficient'</span>,s<span class="op">=</span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.1se</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                       s1
## (Intercept)    -0.570950
## data1.sex1     -0.429630
## data1.cp1       .       
## data1.cp2       0.610299
## data1.cp3       .       
## data1.fbs1      .       
## data1.restecg1  0.007149
## data1.restecg2  .       
## data1.exang1   -0.678984
## data1.slope1   -0.261868
## data1.slope2    0.194103
## data1.ca1      -0.883563
## data1.ca2      -0.944469
## data1.ca3      -0.586744
## data1.ca4       .       
## data1.thal1     .       
## data1.thal2     0.200315
## data1.thal3    -0.752414
## age             .       
## trestbps       -0.000139
## chol            .       
## thalach         0.012869
## oldpeak        -0.245773</code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cv.fit</span>,type<span class="op">=</span><span class="st">'coefficient'</span>,s<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 23 x 1 sparse Matrix of class "dgCMatrix"
##                       s1
## (Intercept)    -1.129256
## data1.sex1      .       
## data1.cp1       .       
## data1.cp2       0.135400
## data1.cp3       .       
## data1.fbs1      .       
## data1.restecg1  .       
## data1.restecg2  .       
## data1.exang1   -0.454297
## data1.slope1    .       
## data1.slope2    0.052755
## data1.ca1      -0.036494
## data1.ca2       .       
## data1.ca3       .       
## data1.ca4       .       
## data1.thal1     .       
## data1.thal2     0.614504
## data1.thal3    -0.220414
## age             .       
## trestbps        .       
## chol            .       
## thalach         0.008586
## oldpeak        -0.146561</code></pre>
</div>
<div id="测试集验证集中-验证" class="section level4" number="3.1.4.2">
<h4>
<span class="header-section-number">3.1.4.2</span> 测试集\验证集中 验证<a class="anchor" aria-label="anchor" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E9%AA%8C%E8%AF%81%E9%9B%86%E4%B8%AD-%E9%AA%8C%E8%AF%81"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/rms/">rms</a></span><span class="op">)</span></span>
<span><span class="co">#导入验证集</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">testset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span></span></code></pre></div>
<pre><code>## tibble [61 × 14] (S3: tbl_df/tbl/data.frame)
##  $ age     : num [1:61] 63 56 44 64 58 58 57 61 60 54 ...
##  $ sex     : num [1:61] 1 0 1 1 0 1 0 0 1 1 ...
##  $ cp      : num [1:61] 3 1 1 3 2 2 0 0 0 0 ...
##  $ trestbps: num [1:61] 145 140 120 110 120 132 120 130 130 124 ...
##  $ chol    : num [1:61] 233 294 263 211 340 224 354 330 253 266 ...
##  $ fbs     : num [1:61] 1 0 0 0 0 0 0 0 0 0 ...
##  $ restecg : num [1:61] 0 0 1 0 1 0 1 0 1 0 ...
##  $ thalach : num [1:61] 150 153 173 144 172 173 163 169 144 109 ...
##  $ exang   : num [1:61] 0 0 0 1 0 0 1 0 1 1 ...
##  $ oldpeak : num [1:61] 2.3 1.3 0 1.8 0 3.2 0.6 0 1.4 2.2 ...
##  $ slope   : num [1:61] 0 1 2 1 2 2 2 2 2 1 ...
##  $ ca      : num [1:61] 0 0 0 0 0 2 0 0 1 1 ...
##  $ thal    : num [1:61] 1 2 3 2 2 3 2 2 3 3 ...
##  $ target  : Factor w/ 2 levels "no","yes": 2 2 2 2 2 1 2 1 1 1 ...</code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="co">#制作x矩阵</span></span>
<span><span class="va">test</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">9</span>,<span class="fl">11</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">9</span>,<span class="fl">11</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span>, <span class="va">factor</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x.factors_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SparseM/man/SparseM.hb.html">model.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">target</span> <span class="op">~</span> <span class="va">test</span><span class="op">$</span><span class="va">sex</span> <span class="op">+</span> <span class="va">test</span><span class="op">$</span><span class="va">cp</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">fbs</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">restecg</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">exang</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">slope</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">ca</span><span class="op">+</span><span class="va">test</span><span class="op">$</span><span class="va">thal</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">newx</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x.factors_test</span>,<span class="va">test</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>利用lasso在测试集中保存预测值，验证集当中的预测值</li>
</ul>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cv.fit</span>, newx <span class="op">=</span> <span class="va">newx</span>, type <span class="op">=</span> <span class="st">"response"</span>, s<span class="op">=</span><span class="va">cv.fit</span><span class="op">$</span><span class="va">lambda.1se</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/rms/">rms</a></span><span class="op">)</span></span>
<span><span class="co">#在R当中做calibration plot</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">test</span>,<span class="va">test.y</span><span class="op">)</span></span>
<span><span class="co"># write.csv(test,file="test0.csv")</span></span>
<span><span class="co"># str(test)</span></span>
<span><span class="co">##########val.prob#####</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/val.prob.html">val.prob</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">s1</span>,<span class="va">test</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-21-1.png" width="576"></div>
<pre><code>##        Dxy    C (ROC)         R2          D   D:Chi-sq 
##  9.143e-01  9.571e-01  6.671e-01  6.701e-01  4.187e+01 
##        D:p          U   U:Chi-sq        U:p          Q 
##         NA -3.602e-01 -1.997e+01  1.000e+00  1.030e+00 
##      Brier  Intercept      Slope       Emax        E90 
##  1.134e+00 -6.258e-02  2.432e+00  1.180e+00  1.168e+00 
##       Eavg        S:z        S:p 
##  1.016e+00 -6.885e+00  5.791e-12</code></pre>
</div>
</div>
<div id="训练集建立模型" class="section level3" number="3.1.5">
<h3>
<span class="header-section-number">3.1.5</span> 训练集建立模型<a class="anchor" aria-label="anchor" href="#%E8%AE%AD%E7%BB%83%E9%9B%86%E5%BB%BA%E7%AB%8B%E6%A8%A1%E5%9E%8B"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>训练Logistic</li>
</ul>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitControl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"none"</span>, classProbs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10101</span><span class="op">)</span> <span class="co"># 设置种子数，复现结果</span></span>
<span><span class="va">LR_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">target</span><span class="op">~</span><span class="va">.</span> ,</span>
<span>                  data <span class="op">=</span> <span class="va">trainset</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>                  trControl <span class="op">=</span> <span class="va">fitControl</span>,</span>
<span>                  metric <span class="op">=</span> <span class="st">"ROC"</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>训练随机森林</li>
</ul>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10101</span><span class="op">)</span> <span class="co"># 设置种子数，复现结果</span></span>
<span><span class="va">RF_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">target</span><span class="op">~</span><span class="va">.</span> ,</span>
<span>                  data <span class="op">=</span> <span class="va">trainset</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"parRF"</span>,</span>
<span>                  trControl <span class="op">=</span> <span class="va">fitControl</span>,</span>
<span>                  metric <span class="op">=</span> <span class="st">"ROC"</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>训练SVM</li>
</ul>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10101</span><span class="op">)</span> <span class="co"># 设置种子数，复现结果</span></span>
<span><span class="va">SVM_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">target</span><span class="op">~</span><span class="va">.</span> ,</span>
<span>                  data <span class="op">=</span> <span class="va">trainset</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"svmRadial"</span>,</span>
<span>                  trControl <span class="op">=</span> <span class="va">fitControl</span>,</span>
<span>                  metric <span class="op">=</span> <span class="st">"ROC"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="测试集评价模型" class="section level3" number="3.1.6">
<h3>
<span class="header-section-number">3.1.6</span> 测试集评价模型<a class="anchor" aria-label="anchor" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E8%AF%84%E4%BB%B7%E6%A8%A1%E5%9E%8B"><i class="fas fa-link"></i></a>
</h3>
<p>从临床预测模型角度，构建模型有三度。区分度、校准度和临床实用性</p>
<p>区分度我们通常采用的是AUROC或C-Index；</p>
<p>校准度评价采用的是HL（hosmer lemeshow）检验以及校准曲线。</p>
<p>Briser Score综合区分度和校准度的表现呢。</p>
<div id="区分度" class="section level4" number="3.1.6.1">
<h4>
<span class="header-section-number">3.1.6.1</span> 区分度<a class="anchor" aria-label="anchor" href="#%E5%8C%BA%E5%88%86%E5%BA%A6"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>获得模型测试集风险概率</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LR_pro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span> <span class="op">(</span><span class="va">LR_model</span>, newdata <span class="op">=</span><span class="va">testset</span>, type<span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> </span>
<span><span class="va">RF_pro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span> <span class="op">(</span><span class="va">RF_model</span>, newdata <span class="op">=</span><span class="va">testset</span>, type<span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> </span>
<span><span class="va">SVM_pro</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span> <span class="op">(</span><span class="va">SVM_model</span>, newdata <span class="op">=</span><span class="va">testset</span>, type<span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">LR</span> <span class="op">&lt;-</span> <span class="va">LR_pro</span><span class="op">$</span><span class="va">yes</span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">RF</span> <span class="op">&lt;-</span> <span class="va">RF_pro</span><span class="op">$</span><span class="va">yes</span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">SVM</span> <span class="op">&lt;-</span> <span class="va">SVM_pro</span><span class="op">$</span><span class="va">yes</span></span></code></pre></div>
<ul>
<li>使用plotROC包和ggplot2绘制ROC曲线</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ROC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plotROC/man/melt_roc.html">melt_roc</a></span><span class="op">(</span><span class="va">testset</span>, <span class="st">"target"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LR"</span>, <span class="st">"RF"</span>, <span class="st">"SVM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ROC_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ROC</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>d <span class="op">=</span> <span class="va">D.target</span>, m <span class="op">=</span> <span class="va">M</span>, color <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/plotROC/man/geom_roc.html">geom_roc</a></span><span class="op">(</span>n.cuts <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"三种模型测试集ROC曲线"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># theme(text = element_text(size = 50)) 设置所有字体大小</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ROC_plot</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-27-1.png" width="576"></div>
<ul>
<li>pROC包的roc()和auc()函数，计算AUC</li>
</ul>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roc_LR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span>, <span class="va">testset</span><span class="op">$</span><span class="va">LR</span><span class="op">)</span></span>
<span><span class="va">auc_LR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span><span class="op">(</span><span class="va">roc_LR</span><span class="op">)</span></span>
<span><span class="va">auc_LR</span>   <span class="co"># Area under the curve: 0.956</span></span></code></pre></div>
<pre><code>## Area under the curve: 0.956</code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roc_RF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span>, <span class="va">testset</span><span class="op">$</span><span class="va">RF</span><span class="op">)</span></span>
<span><span class="va">auc_RF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span><span class="op">(</span><span class="va">roc_RF</span><span class="op">)</span></span>
<span><span class="va">auc_RF</span>   <span class="co"># Area under the curve: 0.935</span></span></code></pre></div>
<pre><code>## Area under the curve: 0.935</code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roc_SVM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span>, <span class="va">testset</span><span class="op">$</span><span class="va">SVM</span><span class="op">)</span></span>
<span><span class="va">auc_SVM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/auc.html">auc</a></span><span class="op">(</span><span class="va">roc_SVM</span><span class="op">)</span></span>
<span><span class="va">auc_SVM</span>  <span class="co"># Area under the curve: 0.969</span></span></code></pre></div>
<pre><code>## Area under the curve: 0.969</code></pre>
</div>
<div id="校准度" class="section level4" number="3.1.6.2">
<h4>
<span class="header-section-number">3.1.6.2</span> 校准度<a class="anchor" aria-label="anchor" href="#%E6%A0%A1%E5%87%86%E5%BA%A6"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>校准曲线</li>
</ul>
<blockquote>
<p>最理想的情况下, 校准曲线是一条对角线(预测概率等于经验概率)，表现较差的模型的校准曲线是sigmoid形的。</p>
</blockquote>
<p>使用rms包的calibration()函数 和ggplot2包绘制三种模型的校准曲线。</p>
<p>能够看到，与对角线相比，两个模型的校准曲线存在一些偏差，整体上三种模型的校准曲线部分位于对角线上方（低估风险），部分位于下方（高估风险）。校准曲线置信区间宽度较大，这可能是由于样本量较小。但整体尚可。</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/trellis.par.get.html">trellis.par.set</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/caret-internal.html">caretTheme</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cal_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/calibration.html">calibration</a></span><span class="op">(</span><span class="va">target</span> <span class="op">~</span> <span class="va">LR</span><span class="op">+</span><span class="va">RF</span><span class="op">+</span><span class="va">SVM</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">testset</span>, class <span class="op">=</span> <span class="st">"yes"</span>, cuts <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">CC_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cal_obj</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"三种模型测试集校准曲线"</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CC_plot</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-30-1.png" width="576"></div>
<ul>
<li>Brier评分</li>
</ul>
<blockquote>
<p>Brier Score（BS）评分用于评价模型的总体表现（overall performance），如果模型总体表现完美，那么预测值和实际值就完全一致，那么BS评分就等于零。如果BS&gt;0.25，某些文献则认为worthless。</p>
</blockquote>
<p>Brier评分=∑(Y-P)^2/N，其中Y为实际观测概率，P为模型预测概率，N为总样本量。Brier评分取值范围0～1，Brier评分值越小，校准度越高。</p>
<p>能够看到，三个模型的Brier评分都比较小，没有超过0.2，其中LR模型的Brier评分最小。</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LR_brier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">LR</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">LR_brier</span>  <span class="co"># 0.0735</span></span></code></pre></div>
<pre><code>## [1] 0.0735</code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RF_brier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">RF</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">RF_brier</span>  <span class="co"># 0.1011</span></span></code></pre></div>
<pre><code>## [1] 0.1011</code></pre>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SVM_brier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">SVM</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">SVM_brier</span>  <span class="co"># 0.07433</span></span></code></pre></div>
<pre><code>## [1] 0.07433</code></pre>
</div>
<div id="临床实用性" class="section level4" number="3.1.6.3">
<h4>
<span class="header-section-number">3.1.6.3</span> 临床实用性<a class="anchor" aria-label="anchor" href="#%E4%B8%B4%E5%BA%8A%E5%AE%9E%E7%94%A8%E6%80%A7"><i class="fas fa-link"></i></a>
</h4>
<blockquote>
<p>DCA曲线</p>
<p>DCA曲线横坐标是判断恶性/良性的风险阈值（0~1），纵坐标为不同阈值对应的临床净获益（net benifit）。主要比较了根据四种模型划分恶性/良性患者（针对性干预），相比于把所有患者都看作恶性实施干预（ALL曲线）和所有患者都不干预（None曲线），是否有临床净获益。</p>
<p>006年首次介绍了DCA曲线，并提供了使用R语言绘制DCA曲线的dca()函代码下载链接：<a href="https://www.mskcc.org/departments/epidemiology-biostatistics/biostatistics/decision-curve-analysis" class="uri">https://www.mskcc.org/departments/epidemiology-biostatistics/biostatistics/decision-curve-analysis</a></p>
</blockquote>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testset</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">target</span> <span class="op">==</span> <span class="st">"yes"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># write_csv(testset, file = "data/testset.csv")</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"dca/dca.r"</span><span class="op">)</span></span>
<span><span class="va">testset1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/testset.csv"</span><span class="op">)</span></span>
<span><span class="va">DCA</span> <span class="op">&lt;-</span> <span class="fu">dca</span><span class="op">(</span>data <span class="op">=</span> <span class="va">testset1</span>, outcome <span class="op">=</span> <span class="st">"target"</span>,</span>
<span>           predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LR"</span>, <span class="st">"RF"</span>, <span class="st">"SVM"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-33-1.png" width="576"></div>
<p>能够看到，当风险阈值范围在0~1 时，三种模型的临床净获益均高于ALL曲线和None曲线，能够取得临床净获益的阈值范围还是比较大的，但应该注意的是，随着阈值增大，四种模型的临床净获益也在减小。</p>
</div>
</div>
<div id="logistic的nomogram绘制" class="section level3" number="3.1.7">
<h3>
<span class="header-section-number">3.1.7</span> Logistic的Nomogram绘制<a class="anchor" aria-label="anchor" href="#logistic%E7%9A%84nomogram%E7%BB%98%E5%88%B6"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 解决"variable 变量名 does not have limits defined by datadist"</span></span>
<span><span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rms/man/datadist.html">datadist</a></span><span class="op">(</span><span class="va">testset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>datadist<span class="op">=</span><span class="st">"dd"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 设置变量标签</span></span>
<span><span class="va">testset</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">testset</span><span class="op">$</span><span class="va">sex</span>,levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Female"</span>,<span class="st">"Male"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># 构建LR模型</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rms/man/lrm.html">lrm</a></span><span class="op">(</span><span class="va">target</span><span class="op">~</span> <span class="va">age</span><span class="op">+</span><span class="va">sex</span><span class="op">+</span><span class="va">chol</span><span class="op">+</span><span class="va">oldpeak</span>, data<span class="op">=</span> <span class="va">testset</span>, x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 绘制Nomogram</span></span>
<span><span class="va">nom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rms/man/nomogram.html">nomogram</a></span><span class="op">(</span><span class="va">f1</span>,</span>
<span>                fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                <span class="co">#也可fun=plogis,fun.at概率坐标范围</span></span>
<span>                fun.at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.001</span>,<span class="fl">.01</span>,<span class="fl">.05</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>,<span class="fl">.9</span>,by<span class="op">=</span><span class="fl">.1</span><span class="op">)</span>,<span class="fl">.95</span>,<span class="fl">.99</span>,<span class="fl">.999</span><span class="op">)</span>,</span>
<span>                funlabel<span class="op">=</span><span class="st">"Risk of target"</span>,</span>
<span>                conf.int<span class="op">=</span><span class="cn">F</span>,</span>
<span>                abbrev<span class="op">=</span><span class="cn">F</span>,</span>
<span>                minlength<span class="op">=</span><span class="fl">1</span>,</span>
<span>                <span class="co">#lp线性预测值</span></span>
<span>                lp<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">nom</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="03-r_example_files/figure-html/unnamed-chunk-35-1.png" width="576"></div>
<ul>
<li>另外一种</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">regplot</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/regplot/man/regplot.html">regplot</a></span><span class="op">(</span><span class="va">f1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "note: points tables not constructed unless points=TRUE "</code></pre>
<div class="inline-figure"><img src="images/0301.png" width="100%"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="%E5%AE%9E%E6%93%8D%E6%95%99%E5%AD%A6-1.html">实操教学</a></div>
<div class="next"><a href="python-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%85%A5%E9%97%A8.html"><span class="header-section-number">4</span> Python 安装与入门</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#r-%E5%AE%9E%E6%93%8D"><span class="header-section-number">3</span> R 实操</a></li>
<li>
<a class="nav-link" href="#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA"><span class="header-section-number">3.1</span> 机器学习模型构建</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E9%9C%80%E8%A6%81%E7%9A%84r%E5%8C%85"><span class="header-section-number">3.1.1</span> 加载需要的r包</a></li>
<li><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><span class="header-section-number">3.1.2</span> 加载数据</a></li>
<li><a class="nav-link" href="#%E5%88%92%E5%88%86%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="header-section-number">3.1.3</span> 划分数据集</a></li>
<li><a class="nav-link" href="#lasso%E5%8F%98%E9%87%8F%E7%AD%9B%E9%80%89"><span class="header-section-number">3.1.4</span> lasso变量筛选</a></li>
<li><a class="nav-link" href="#%E8%AE%AD%E7%BB%83%E9%9B%86%E5%BB%BA%E7%AB%8B%E6%A8%A1%E5%9E%8B"><span class="header-section-number">3.1.5</span> 训练集建立模型</a></li>
<li><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E8%AF%84%E4%BB%B7%E6%A8%A1%E5%9E%8B"><span class="header-section-number">3.1.6</span> 测试集评价模型</a></li>
<li><a class="nav-link" href="#logistic%E7%9A%84nomogram%E7%BB%98%E5%88%B6"><span class="header-section-number">3.1.7</span> Logistic的Nomogram绘制</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/03-r_example.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/03-r_example.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>临床预测模型</strong>" was written by 杨 弘. It was last built on 2023-02-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
